# YARA-HAR

YARA-HAR is a small overlay on top of YARA, to analyze HAR file. It uses [yara-jsonschema](https://github.com/marmeladema/yara-jsonschema) to generate a module based the HAR jsonschema description.

## HAR file structure
HAR files are usually generated by web browsers as trace of their activity. It is a JSON file composed of a root object, where each HTTP request/response pairs are recorded in the `log.entries` array. Each HAR entry contains useful information such as:

* Request headers
* Request body (if any)
* Response header
* Response body

YARA-HAR will go over every HAR entries, and call YARA for each request and response body, decoded if needed, while also providing the HAR entry as a YARA module object.

## Compilation
YARA-HAR uses CMake as build system. You just need to:

* create a build directory
```
~/yara-har $ mkdir build
~/yara-har $ cd build
```

* call CMake to generate all the necessary build files
```
~/yara-har $ cmake ..
-- The C compiler identification is GNU 8.2.0
-- The CXX compiler identification is GNU 8.2.0
-- Check for working C compiler: /usr/bin/cc
-- Check for working C compiler: /usr/bin/cc -- works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Detecting C compile features
-- Detecting C compile features - done
-- Check for working CXX compiler: /usr/bin/c++
-- Check for working CXX compiler: /usr/bin/c++ -- works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Found OpenSSL: /usr/lib/libcrypto.so (found version "2.0.0") found components:  Crypto
-- Looking for pthread.h
-- Looking for pthread.h - found
-- Looking for pthread_create
-- Looking for pthread_create - not found
-- Looking for pthread_create in pthreads
-- Looking for pthread_create in pthreads - not found
-- Looking for pthread_create in pthread
-- Looking for pthread_create in pthread - found
-- Found Threads: TRUE
-- Configuring done
-- Generating done
-- Build files have been written to: ~/yara-har/build
```

* call it again to build everything
```
~/yara-har $ cmake --build .
[...]
Scanning dependencies of target yara-har-lib
[ 69%] Building C object CMakeFiles/yara-har-lib.dir/libyara-har.c.o
[ 76%] Building C object CMakeFiles/yara-har-lib.dir/mbedtls/base64.c.o
[ 84%] Linking C shared library libyara-har.so
[ 84%] Built target yara-har-lib
Scanning dependencies of target yara-har-bin
[ 92%] Building C object CMakeFiles/yara-har-bin.dir/yara-har.c.o
[100%] Linking C executable yara-har
[100%] Built target yara-har-bin
```

* eventualy call it again to execute tests
```
~/yara-har $ cmake --build . --target test
Running tests...
Test project /home/adema/code/yara-har/build
    Start 1: firefox.google.favicon
1/2 Test #1: firefox.google.favicon ...........   Passed    0.03 sec
    Start 2: chromium.google.favicon
2/2 Test #2: chromium.google.favicon ..........   Passed    0.03 sec

100% tests passed, 0 tests failed out of 2

Total Test time (real) =   0.06 sec
```

## Examples
A simple rule to check the md5 of a file:
```
import "hash"

rule favicon
{
        condition:
                hash.md5(0, filesize) == "f3418a443e7d841097c714d69ec4bcb8"
}
```

You can also use the har_entry module to access the HAR entry object exposed as a module object:
```
import "har_entry"
import "hash"

rule favicon
{
        condition:
                har_entry.request.url == "https://www.google.com/favicon.ico" and
                hash.md5(0, filesize) == "f3418a443e7d841097c714d69ec4bcb8"
}
```
